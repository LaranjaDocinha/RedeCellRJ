name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite disparar manualmente
    inputs:
      strategy:
        description: 'Deployment Strategy'
        required: true
        default: 'canary'
        type: choice
        options:
          - canary
          - blue-green # Placeholder para futura implementação

jobs:
  build_and_package: # Renomeado para maior clareza
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'
      - name: Install dependencies (Backend)
        run: |
          cd backend
          npm install
      - name: Build Backend
        run: |
          cd backend
          npm run build
      - name: Install dependencies (Frontend)
        run: |
          cd frontend
          npm install
      - name: Build Frontend
        run: |
          cd frontend
          npm run build
      - name: Archive Production Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: production-artifacts
          path: |
            backend/dist/
            frontend/build/ # Ou frontend/dist/, dependendo do seu build

  deploy_to_canary:
    needs: build_and_package
    runs-on: ubuntu-latest
    environment:
      name: canary
      url: https://canary.example.com # URL do ambiente Canary
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: production-artifacts
          path: ./artifacts # Baixa os artefatos para esta folder
      - name: Deploy Backend to Canary
        run: |
          echo "Deploying backend to canary environment..."
          # Ex: scp -r ./artifacts/backend/dist user@canary-server:/app/backend
          # Ex: kubectl apply -f kubernetes/canary-backend.yaml
          echo "Deployment script for backend on canary goes here."
      - name: Deploy Frontend to Canary
        run: |
          echo "Deploying frontend to canary environment..."
          # Ex: scp -r ./artifacts/frontend/build user@canary-server:/app/frontend
          # Ex: kubectl apply -f kubernetes/canary-frontend.yaml
          echo "Deployment script for frontend on canary goes here."
      - name: Update Canary Load Balancer/Traffic Split (Placeholder)
        run: echo "Updating load balancer to send small percentage of traffic to canary..."
        # Ex: update-loadbalancer-traffic --target canary --weight 5%

  monitor_canary:
    needs: deploy_to_canary
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Canary to Stabilize (Placeholder)
        run: sleep 60 # Esperar por 1 minuto para o serviço subir e estabilizar
      - name: Run Automated Smoke/Health Checks
        run: echo "Running automated health checks and basic smoke tests on canary..."
        # Ex: curl --fail http://canary.example.com/health || exit 1
      - name: Monitor Performance and Errors (Placeholder)
        run: echo "Integrate with APM/Observability tools (Sentry, Prometheus) to monitor canary for 15 minutes."
        # Ex: your-monitoring-tool --check-canary --duration 15m

  promote_or_rollback:
    needs: monitor_canary
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://your-production.com # Replace with your actual production URL
    steps:
      - name: Approval for Production Promotion
        if: github.event_name == 'push' # Apenas para push no main
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: 'seu-usuario-github' # Substitua pelo seu usuário ou equipe
          minimum-approvals: 1
          issue-title: "Promover Canary para Produção"
          issue-body: "Aprovar promoção do build ${{ github.sha }} para produção após monitoramento Canary."
          exclude-workflow-initiator: false # O iniciador do workflow pode aprovar

      - name: Perform Full Production Rollout (Canary)
        if: github.event.inputs.strategy == 'canary' || github.event_name == 'push' # Executa se for canary ou push no main
        run: |
          echo "Automated tests and monitoring passed. Shifting traffic 100% to new version..."
          # Ex: update-loadbalancer-traffic --target new-version --weight 100%
          # Ex: kubectl rollout promote deployment/production-app
          echo "Script for full production traffic shift goes here."

      - name: Deploy to Production (Blue/Green Placeholder)
        if: github.event.inputs.strategy == 'blue-green'
        run: |
          echo "Deploying to the 'Green' environment..."
          # Ex: scp -r ./artifacts/backend/dist user@green-server:/app/backend
          # Ex: kubectl apply -f kubernetes/green-app.yaml
          echo "Deployment script for Blue/Green 'Green' environment goes here."

      - name: Switch Traffic (Blue/Green Placeholder)
        if: github.event.inputs.strategy == 'blue-green'
        run: |
          echo "Switching load balancer traffic from 'Blue' to 'Green'..."
          # Ex: update-loadbalancer-traffic --target green
          echo "Script for Blue/Green traffic switch goes here."

      - name: Rollback on Failure (Placeholder)
        if: failure() && (github.event.inputs.strategy == 'canary' || github.event.inputs.strategy == 'blue-green')
        run: |
          echo "Deployment failed. Initiating automated rollback..."
          # Ex: rollback-to-previous-version.sh
          echo "Script for automated rollback goes here."
          # Notificar equipe sobre o rollback
