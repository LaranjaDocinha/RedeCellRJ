name: Frontend CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build_and_test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    - name: Install dependencies
      run: npm install --prefix frontend
    - name: Run tests
      run: npm test --prefix frontend
    - name: Run lint
      run: npm run lint --prefix frontend
    - name: Build frontend application
      run: npm run build --prefix frontend
    - name: Analyze frontend bundle size
      run: npx source-map-explorer 'frontend/build/static/js/*.js'
      continue-on-error: true
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build-${{ github.sha }}
        path: frontend/dist # Assuming build output is in frontend/dist
    - name: Build Storybook
      run: npm run storybook:build --prefix frontend # Using build-storybook script
    - name: Publish Storybook to Chromatic
      uses: chromaui/action@v1
      with:
        projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
        token: ${{ secrets.GITHUB_TOKEN }} # Ensure GITHUB_TOKEN is available for Chromatic
        # Other Chromatic options like exit-zero-on-changes if needed

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_test
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: frontend-build-${{ github.sha }}
        path: ./build-output # Download to a specific directory

    - name: Deploy to Static Hosting (e.g., GitHub Pages, S3)
      run: echo "Deploying frontend artifacts from ./build-output to production..."
      # Add your actual deployment steps here
      # For example:
      # - name: Deploy to AWS S3
      #   uses: jakejarvis/s3-sync-action@master
      #   with:
      #     args: --acl public-read --follow-symlinks --delete
      #   env:
      #     AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
      #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     AWS_REGION: 'us-east-1'
      #   working-directory: ./build-output
    - name: Notify Deployment Success
      run: echo "Frontend deployed successfully to production!"
